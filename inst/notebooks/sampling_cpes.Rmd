---
title: "annotate_cpes"
author: "Humbert Costas"
date: !r Sys.Date()
output: html_document
params:
  seed: 42
  data_path: /DEVEL/code/data/annotation
  path_vers: !r as.character(packageVersion("mitre"))
  output_kind: all
  ner_vendor: FALSE
  ner_product: TRUE
  ner_version: FALSE
  num_samples: 10000
---

```{r imports_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Imports
suppressPackageStartupMessages(library(mitre, warn.conflicts = FALSE))
suppressPackageStartupMessages(library(dplyr, warn.conflicts = FALSE))

# Parameters
p_version <- params$path_vers
p_seed <- as.character(params$seed)
p_data_path <- params$data_path
p_num_samples <- params$num_samples   # value 0 means all
p_kind <- params$output_kind         # RASA | entities | all
p_type <- ifelse(test = (params$ner_vendor & params$ner_product & params$ner_version), 
                 yes = "vpv", 
                 no = ifelse(test = (params$ner_vendor & params$ner_product & !params$ner_version), 
                             yes = "vp", 
                             no = ifelse(test = (!params$ner_vendor & params$ner_product & params$ner_version), 
                                         yes = "pv", 
                                         no = ifelse(test = (params$ner_vendor & !params$ner_product & params$ner_version), 
                                                     yes = "vv", 
                                                     no = ifelse(test = (params$ner_vendor), 
                                                                 yes = "vend", 
                                                                 no = ifelse(test = (params$ner_product), 
                                                                             yes = "prod", 
                                                                             no = "vers"))))))

set.seed(p_seed)
```

```{r check_paths}
# root path
if (!dir.exists(p_data_path))
  dir.create(p_data_path)

# version subpath
name_folder <- file.path(p_data_path, paste0("v", p_version))
if (!dir.exists(name_folder))
  dir.create(name_folder)

# seed subpath
name_folder <- file.path(p_data_path, paste0("v", p_version), p_seed)
if (!dir.exists(name_folder))
  dir.create(name_folder)
```

# Feature Engineering for CPE standard

## Enrich with string features

Let's try another strategy. Now we will select samples using new columns.
First we need to enrich the data. For each column:
 - Length: `len_*`
 - Number of letters: `abc_*`
 - Number of numbers: `num_*`
 - Number of symbols: `sym_*`

```{r feateng}
cpes <- mitre::cpe.nist

df <- mitre::nlp_cpe_feateng(df = cpes)
df_sw <- mitre::nlp_cpe_feateng(df = cpes[cpes$part == "a", ])
df_so <- mitre::nlp_cpe_feateng(df = cpes[cpes$part == "o", ])
df_hw <- mitre::nlp_cpe_feateng(df = cpes[cpes$part == "h", ])

```

Now we are ready to explore them with a PCA...

```{r pca_summary}
acum_prop <- 0.75
pca <- prcomp(dplyr::select(df, -c("title", "part", "vendor", "product", "version")), scale = T)
pca_sum <- summary(pca)
pc_selected  <- sum(as.data.frame(pca_sum$importance)[3,] < acum_prop) + 1
pca_sum
```
The first `r pc_selected` principal components explains more than `r acum_prop*100`% of the data variance.

```{r pca_importance}
PVE <- 100 * pca$sdev^2 / sum(pca$sdev^2)

par(mfrow = c(1,2))
plot(PVE, type = "o",
     ylab = "PVE",
     xlab = "Componente principal",
     col = "blue")
plot(cumsum(PVE), type = "o",
     ylab = "PVE acumulada",
     xlab = "Componente principal",
     col = "brown3")
```

```{r pca_screeplot}
ylimtop <- ceiling(PVE[1]) + 10 - (ceiling(PVE[1]) %% 10)
factoextra::fviz_screeplot(pca, addlabels = TRUE, ylim = c(0, ylimtop))


```


```{r pca_contribution}
factoextra::fviz_contrib(pca, choice = "var", axes = 1:pc_selected)

```


```{r pca_contribution_split}
pca_contrib <- factoextra::fviz_contrib(pca, choice = "var", axes = 1:pc_selected)
yintercept <- pca_contrib$layers[[2]]$data$yintercept
feat_selected <- as.character(pca_contrib$plot_env$data_sum$name[pca_contrib$plot_env$data_sum$contrib > yintercept])
feat_selected
paste(feat_selected, sep = ", ")
```


Let's check the correlation, maybe we can reduce some features...

```{r plot_correlation}
DataExplorer::plot_correlation(dplyr::select(df, c(feat_selected)))

```

  
We can observe high correlation with length and alphabetic. It seems reasonable 
to keep remove highly correlated features, for example `len_title` and  `len_product`.

Let's see what happen without them.

```{r pca_lite_summary}
exclude_feats <- c("len_title", "len_product")

feat_selected <- feat_selected[!(feat_selected %in% exclude_feats)]
pca_lite <- prcomp(dplyr::select(df, feat_selected), 
                        scale = T)

pca_lite_sum <- summary(pca_lite)
pc_lite_selected  <- sum(as.data.frame(pca_lite_sum$importance)[3,] < acum_prop) + 1
pca_lite_sum
summary(pca_lite)

```
Minor improvement is noticed. The first `r pc_lite_selected` PCs explain more than `r acum_prop*100`% of the data variance.

Let's explore the features...

```{r pca_lite_importance}
PVE <- 100 * pca_lite$sdev^2 / sum(pca_lite$sdev^2)

par(mfrow = c(1,2))
plot(PVE, type = "o",
     ylab = "PVE",
     xlab = "Componente principal",
     col = "blue")
plot(cumsum(PVE), type = "o",
     ylab = "PVE acumulada",
     xlab = "Componente principal",
     col = "brown3")
```

```{r pca_lite_contribution}
factoextra::fviz_contrib(pca_lite, choice = "var", axes = 1:pc_lite_selected)

```

```{r pca_lite_contribution_split}
pca_lite_contrib <- factoextra::fviz_contrib(pca_lite, choice = "var", axes = 1:pc_lite_selected)
yintercept_lite <- pca_lite_contrib$layers[[2]]$data$yintercept
feat_lite_selected <- as.character(pca_lite_contrib$plot_env$data_sum$name[pca_lite_contrib$plot_env$data_sum$contrib > yintercept_lite])

paste(feat_lite_selected, sep = ", ")
```
Finally the features to use for weighted sampling are: **`r paste(feat_lite_selected, sep = ", ")`**.


## Sample data set using

```{r sample_dist}
sam_size <- floor((p_num_samples*2) / length(feat_lite_selected))
sam_size_extra <- (p_num_samples*2) %% length(feat_lite_selected)

df_sample <- rbind(dplyr::sample_n(df, size = sam_size + sam_size_extra, weight = df[[feat_lite_selected[1]]]),
            dplyr::sample_n(df, size = sam_size, weight = df[[feat_lite_selected[2]]]),
            dplyr::sample_n(df, size = sam_size, weight = df[[feat_lite_selected[3]]]),
            dplyr::sample_n(df, size = sam_size, weight = df[[feat_lite_selected[4]]]),
            dplyr::sample_n(df, size = sam_size, weight = df[[feat_lite_selected[5]]]))
df_sample$id <- 1:nrow(df_sample)
df_sample <- df_sample[, c("id", "title", "part", "vendor", "product", "version")]


df_rasa <- mitre::nlp_cpe_annotate(df = df_sample, type = p_type, kind = "RASA")
df_rasa <- dplyr::sample_n(df_rasa, p_num_samples)
saveRDS(df_rasa, file.path(name_folder, paste0("sampling_cpes_rasa.rds")))

```

