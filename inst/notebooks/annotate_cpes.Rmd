---
title: "annotate_cpes"
author: "Humbert Costas"
date: !r Sys.Date()
output: html_document
params:
  seed: 42
  data_path: /DEVEL/code/data/annotation
  path_vers: !r as.character(packageVersion("mitre"))
  output_kind: all
  ner_vendor: FALSE
  ner_product: TRUE
  ner_version: FALSE
  num_samples: 100
---

```{r imports_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Imports
suppressPackageStartupMessages(library(mitre, warn.conflicts = FALSE))
suppressPackageStartupMessages(library(dplyr, warn.conflicts = FALSE))

# Parameters
p_version <- params$path_vers
p_seed <- as.character(params$seed)
p_data_path <- params$data_path
p_num_samples <- params$num_samples   # value 0 means all
p_kind <- params$output_kind         # RASA | entities | all

p_type <- paste0(ifelse(params$ner_vendor, "v", ""),
                 ifelse(params$ner_product, "p", ""),
                 ifelse(params$ner_version, "v", ""))
if (nchar(p_type) == 1) {
  p_type <- ifelse(params$ner_vendor, "vend",
                   ifelse(params$ner_product, "prod", "vers"))
}
set.seed(p_seed)
```

```{r check_paths}
# root path
if (!dir.exists(p_data_path))
  dir.create(p_data_path)

# version subpath
name_folder <- file.path(p_data_path, paste0("v", p_version))
if (!dir.exists(name_folder))
  dir.create(name_folder)

# seed subpath
name_folder <- file.path(p_data_path, paste0("v", p_version), p_seed)
if (!dir.exists(name_folder))
  dir.create(name_folder)
```

## Annotate CPE standard

```{r get_annotated_cpes}
if (p_kind %in% c("all", "RASA")) {
  # Load CPEs annotated with RASA
  if (file.exists(file.path(name_folder, paste0("cpes_", p_type,"_rasa.rds")))) {
    df_rasa <- readRDS(file.path(name_folder, paste0("cpes_", p_type,"_rasa.rds")))
  } else {
    df_rasa <- mitre::nlp_cpe_annotate(type = p_type, kind = "RASA")
    saveRDS(df_rasa, file.path(name_folder, paste0("cpes_", p_type,"_rasa.rds")))
  }
  readr::write_csv(x = df_rasa,
                   file = file.path(name_folder,paste0("cpes_", p_type,"_rasa.csv")),
                   col_names = FALSE)
}

if (p_kind %in% c("all", "entities")) {
  # Load CPEs annotated with ENTITIES
  if (file.exists(file.path(name_folder, paste0("cpes_", p_type,"_entities.rds")))) {
    df_enti <- readRDS(file.path(name_folder, paste0("cpes_", p_type,"_entities.rds")))
  } else {
    df_enti <- mitre::nlp_cpe_annotate(type = p_type, kind = "entities")
    saveRDS(df_enti, file.path(name_folder, paste0("cpes_", p_type,"_entities.rds")))
  }
  readr::write_csv(x = df_enti,
                   file = file.path(name_folder,paste0("cpes_", p_type,"_entities.csv")),
                   col_names = FALSE)
}
```

## Sampling annotated CPE standard

This sampling version is trying to get observations from different
vendors; to avoid having huge samples of the most common vendors, and ensure 
that contains non common observations.

```{r create_rasa_sample}

if (p_kind %in% c("all", "RASA")) {
  cpes_custom <- nlp.ner_cpe_trainset(kind = "RASA", type = p_type,
                                      num_samples = p_num_samples,
                                      rdataset = file.path(name_folder, paste0("cpes_", p_type,"_rasa.rds")),
                                      seed = p_seed) %>%
    select(title, annotated)
  if (p_num_samples >= 1000) {
    name_file <- file.path(name_folder, paste0("cpes_rasa_", p_type,"_", round(p_num_samples / 1000, 1), "k.csv"))
  } else {
    name_file <- file.path(name_folder,paste0("cpes_rasa_", p_type,"_", p_num_samples, ".csv"))
  }
  readr::write_csv(x = cpes_custom, file = name_file, col_names = FALSE)
}

if (p_kind %in% c("all", "entities")) {
  cpes_custom <- nlp.ner_cpe_trainset(kind = "entities", type = p_type,
                                      num_samples = p_num_samples,
                                      rdataset = file.path(name_folder, paste0("cpes_", p_type,"_entities.rds")),
                                      seed = p_seed) %>%
    select(title, annotated)
  if (p_num_samples >= 1000) {
    name_file <- file.path(name_folder,paste0("cpes_entities_", p_type,"_", round(p_num_samples / 1000, 1), "k.csv"))
  } else {
    name_file <- file.path(name_folder,paste0("cpes_entities_", p_type,"_", p_num_samples, ".csv"))
  }
  readr::write_csv(x = cpes_custom, file = name_file, col_names = FALSE)
}

```
